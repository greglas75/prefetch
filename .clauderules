# Claude Rules — Prefetch Detection Project

## Project Type
Single-page vanilla JS app + Node.js HTTP server. No framework, no bundler, no dependencies.
Deployed on Vercel (static). Data stored in Supabase (PostgreSQL).

---

## ARCHITECTURE RULES

### Single-file frontend:
- `index.html` contains ALL frontend code: HTML + CSS + JS. Do NOT split into separate files.
- No npm packages on the frontend. Vanilla JS only. No jQuery, no React, no build step.
- External requests: ONLY to `/collect` (local) and Supabase REST API. No CDNs, no Google Fonts, no analytics scripts.

### Server is local-only:
- `server.js` runs on localhost for development/testing. It does NOT run on Vercel.
- Vercel serves `index.html` as static. All data goes directly to Supabase from the client.
- Never add `node_modules` dependencies to the project. Use only Node.js built-in modules (`http`, `fs`, `path`).

### Data collection is dual:
- Local server: writes to JSONL files (fast, for development)
- Supabase: REST API inserts (production, from Vercel)
- Both paths must stay in sync. If you add a field to one, add it to the other.

---

## PERFORMANCE RULES (CRITICAL)

This page must load and send first data **within 100ms**. Facebook prefetches can be killed in <300ms.

- `page_init` event fires **immediately** on script parse. No `setTimeout`, no `DOMContentLoaded` wait.
- Heartbeat to local server: every **150ms** (lightweight ~100 bytes).
- Heartbeat to Supabase: every **2s** (throttled to respect rate limits).
- Full payloads only on key events, never on heartbeat.
- Use `navigator.sendBeacon()` for local server (fire-and-forget).
- Use `fetch()` with `keepalive: true` for Supabase (needs custom headers).
- Server-side: buffer heartbeats in memory, flush to disk every 2s. Never `appendFileSync` on every request.

---

## TRACKING DATA RULES

### Every change to detection fields must be reflected in:
1. The `detection` object in `index.html`
2. The `sendHeartbeat()` pulse object (if applicable)
3. The `sendHeartbeatSB()` Supabase insert (if applicable)
4. The Supabase table schema (run migration if adding columns)
5. The dashboard in `server.js` (if it should be visible)

### Screen timing must be millisecond-precise:
- `screen_enter_ms[step]` set via `Date.now()` on step enter
- `screen_durations_ms[step]` accumulated on step exit
- `screen_visits[step]` tracks every enter/exit pair
- Current screen duration calculated live before every `sendData()` call

---

## ACCESSIBILITY RULES (MANDATORY)

Target: **Lighthouse Accessibility 100**. Every element must pass WCAG 2.1 AA.

- All interactive elements must be keyboard-navigable (Tab, Enter, Space, Arrow keys).
- All `role="radio"` elements must have `aria-checked`, `tabindex`, and keyboard handlers.
- All `role="progressbar"` elements must have `aria-label`, `aria-valuenow`, `aria-valuemin`, `aria-valuemax`.
- Decorative elements (icons, dividers) must have `aria-hidden="true"`.
- Dynamic content areas must have `aria-live="polite"`.
- Color contrast: minimum 4.5:1 ratio for normal text, 3:1 for large text. Use `--muted: #595959` minimum.
- Never use `opacity` to dim text — it breaks contrast ratios.

---

## COLOR SCHEME (TGM Panel — DO NOT CHANGE)

```css
--bg: #F5F3F7;          /* light purple tint */
--card: #FFFFFF;
--text: #1A1A1A;
--muted: #595959;        /* WCAG AA compliant on --bg */
--accent: #7B2D8E;       /* purple — progress, labels, radio selection */
--accent-light: #F3E5F5; /* light purple — selected option bg */
--accent-hover: #5E1A6E; /* dark purple */
--cta: #E91E63;          /* pink/crimson — primary buttons */
--cta-hover: #C2185B;    /* dark pink — button hover */
--border: #E0D8E5;       /* purple-gray border */
```

Do NOT introduce new colors without checking contrast ratios first.

---

## SUPABASE RULES

- **Anon key** is embedded in client-side JS — this is intentional (public insert-only).
- RLS policies: anon can INSERT only. No SELECT, UPDATE, DELETE for anon.
- Service role key: use ONLY in local scripts (`setup_db.js`), NEVER in client code.
- Table changes require migration in `supabase/migrations/`.
- Project ref: `dpdzicoybbjlxhwxnpxu`

---

## SECURITY RULES

- Supabase anon key in `index.html` is public by design (insert-only RLS). NOT a secret.
- Supabase service_role key must NEVER appear in `index.html` or any client-facing code.
- Database password must NEVER be committed. Use environment variables or CLI auth.
- `collected_data.jsonl` and `heartbeats.jsonl` are gitignored — they may contain IP addresses.

---

## FILE STRUCTURE

```
Prefetch/
  index.html              — Frontend (HTML + CSS + JS, single file)
  server.js               — Local dev server (Node.js built-ins only)
  setup_db.js             — Supabase verification script
  .gitignore              — Excludes data files and node_modules
  .clauderules            — This file
  CLAUDE.md               — Project overview and key info
  README.md               — Public documentation
  collected_data.jsonl    — Local event data (gitignored)
  heartbeats.jsonl        — Local heartbeat data (gitignored)
  supabase/
    config.toml           — Supabase CLI config
    migrations/           — Database migrations
```

---

## GIT & DEPLOYMENT

- Push to `main` auto-deploys to Vercel at https://startsurvey.vercel.app/
- Commit messages: imperative mood, concise, explain WHY not WHAT.
- Always verify Vercel deployment after push (check https://startsurvey.vercel.app/).
- Never commit data files, secrets, or `.env` files.

---

## BEFORE ANY CHANGE — CHECKLIST

1. Does the change affect tracking data? Update all 5 sync points (see TRACKING DATA RULES).
2. Does it add external requests? **NO** — zero external dependencies on frontend.
3. Does it affect accessibility? Check with Lighthouse after deploying.
4. Does it change the color scheme? Match TGM Panel colors (see above).
5. Will the page still send data within 100ms of load? Test with `?debug=1`.
